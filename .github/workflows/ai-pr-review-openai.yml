name: AI PR Review (OpenAI)

on:
  workflow_dispatch:
    inputs:
      pr_number:
        description: 'PR number to review'
        required: true
        type: number
      model:
        description: 'OpenAI model to use'
        required: false
        default: 'gpt-4o'
        type: choice
        options:
          - gpt-4o
          - o3-mini
          - o1

jobs:
  pr-review:
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
      contents: read
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Get PR details and diff
        id: pr
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          # Get PR details
          pr_data=$(gh pr view ${{ inputs.pr_number }} --json title,body)
          echo "title=$(echo $pr_data | jq -r '.title')" >> $GITHUB_OUTPUT
          echo "body=$(echo $pr_data | jq -r '.body // ""')" >> $GITHUB_OUTPUT
          
          # Get PR diff
          gh pr diff ${{ inputs.pr_number }} > pr_diff.txt
          
          # Truncate if too large (keep first 50000 chars)
          if [ $(wc -c < pr_diff.txt) -gt 50000 ]; then
            head -c 50000 pr_diff.txt > pr_diff_truncated.txt
            echo "TRUNCATED=true" >> $GITHUB_OUTPUT
            mv pr_diff_truncated.txt pr_diff.txt
          else
            echo "TRUNCATED=false" >> $GITHUB_OUTPUT
          fi
      
      - name: Run AI Review
        id: review
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          # Create review prompt
          cat > review_prompt.txt << 'EOF'
          You are an experienced code reviewer. Please review this pull request and provide:

          1. **Summary**: Brief overview of the changes
          2. **Strengths**: What's done well
          3. **Issues**: Bugs, security concerns, or logic errors (if any)
          4. **Suggestions**: Improvements for code quality, performance, or maintainability
          5. **Security**: Any security concerns
          6. **Testing**: Comments on test coverage

          Be constructive and specific. Format your response in markdown.

          PR Title: ${{ steps.pr.outputs.title }}
          PR Description: ${{ steps.pr.outputs.body }}

          Diff:
          EOF
          
          cat pr_diff.txt >> review_prompt.txt
          
          # Escape prompt for JSON
          PROMPT_JSON=$(jq -Rs . < review_prompt.txt)
          
          # Call OpenAI API
          response=$(curl -s https://api.openai.com/v1/chat/completions \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer $OPENAI_API_KEY" \
            -d "{
              \"model\": \"${{ inputs.model }}\",
              \"max_completion_tokens\": 4096,
              \"messages\": [{
                \"role\": \"user\",
                \"content\": $PROMPT_JSON
              }]
            }")
          
          # Debug: save response
          echo "$response" > api_response.json
          
          # Extract review text
          review_text=$(echo "$response" | jq -r '.choices[0].message.content // "Error: No response from API"')
          
          # Check if we got an error
          if echo "$response" | jq -e '.error' > /dev/null 2>&1; then
            error_msg=$(echo "$response" | jq -r '.error.message')
            echo "API Error: $error_msg"
            echo "# ⚠️ API Error" > review.md
            echo "" >> review.md
            echo "Failed to get review from OpenAI API:" >> review.md
            echo "\`\`\`" >> review.md
            echo "$error_msg" >> review.md
            echo "\`\`\`" >> review.md
          else
            # Save to file
            echo "$review_text" > review.md
          fi
          
          # Create truncation warning if needed
          if [ "${{ steps.pr.outputs.TRUNCATED }}" == "true" ]; then
            echo -e "\n\n---\n**⚠️ Note**: The diff was truncated due to size. This review covers the first ~50KB of changes." >> review.md
          fi
          
          echo "review_file=review.md" >> $GITHUB_OUTPUT
      
      - name: Post review as comment
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          cat review.md | gh pr comment ${{ inputs.pr_number }} --body-file -
          
          echo "✅ Review posted to PR #${{ inputs.pr_number }}"
      
      - name: Upload review artifact
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: ai-review-openai-pr-${{ inputs.pr_number }}
          path: |
            review.md
            api_response.json
          retention-days: 30
