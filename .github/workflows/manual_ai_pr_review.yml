name: Manual AI PR Review

on:
  workflow_dispatch:
    inputs:
      pr_number:
        description: "Pull request number to review"
        required: true
        type: number
      ai_image:
        description: "Docker image with AI CLI installed"
        required: true
        default: "your-org/ai-review-cli:latest"
        type: string
      review_command:
        description: "Command executed inside the container (reads prompt from STDIN)"
        required: true
        default: "ai-review --stdin"
        type: string

permissions:
  contents: read
  pull-requests: write

jobs:
  review:
    runs-on: ubuntu-latest
    env:
      PR_NUMBER: ${{ inputs.pr_number }}
      AI_IMAGE: ${{ inputs.ai_image }}
      REVIEW_COMMAND: ${{ inputs.review_command }}
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      AI_API_KEY: ${{ secrets.AI_API_KEY }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Validate required secret
        run: |
          if [ -z "$AI_API_KEY" ]; then
            echo "AI_API_KEY secret is not set"
            exit 1
          fi

      - name: Build review prompt from PR
        run: |
          set -euo pipefail

          gh pr view "$PR_NUMBER" --json title,body,author,baseRefName,headRefName,url > pr.json
          gh pr diff "$PR_NUMBER" > pr.diff

          {
            echo "You are a strict senior code reviewer."
            echo
            echo "Review this pull request and provide:"
            echo "1) Critical issues"
            echo "2) Major issues"
            echo "3) Minor issues"
            echo "4) Suggested fixes"
            echo "5) Final verdict (approve / request changes)"
            echo
            echo "Focus on correctness, regressions, security, and maintainability."
            echo
            echo "PR metadata:"
            cat pr.json
            echo
            echo "PR diff:"
            cat pr.diff
          } > review_input.txt

      - name: Run AI review in Docker
        run: |
          set -euo pipefail

          docker run --rm -i \
            -e AI_API_KEY="$AI_API_KEY" \
            -e OPENAI_API_KEY="$AI_API_KEY" \
            -e ANTHROPIC_API_KEY="$AI_API_KEY" \
            "$AI_IMAGE" \
            sh -lc "$REVIEW_COMMAND" < review_input.txt > review_output.md

      - name: Fallback when output is empty
        run: |
          if [ ! -s review_output.md ]; then
            {
              echo "AI review returned empty output."
              echo
              echo "Please check container image and review command settings."
            } > review_output.md
          fi

      - name: Post review comment to PR
        run: |
          {
            echo "## AI Review"
            echo
            cat review_output.md
          } > gh_comment.md

          gh pr comment "$PR_NUMBER" --body-file gh_comment.md
